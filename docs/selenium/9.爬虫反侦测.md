# 爬虫与反侦测

## 原理

前端可以通过检测全局变量的特征值来检测是否为自动化控制的浏览器,比如 puppteer 会命中 webdriver

```javascript
function detectWebDriver() {
  const r = [];
  const w = ['webdriver', '__driver_evaluate', '__webdriver_evaluate',
  ' __selenium_evaluate', '__fxdriver_evaluate', '__driver_unwrapped',
  '__webdriver_unwrapped', '__selenium_unwrapped', '__fxdriver_unwrapped',
  '_Selenium_IDE_Recorder', '_selenium', 'calledSelenium',
  '_WEBDRIVER_ELEM_CACHE', 'ChromeDriverw', 'driver-evaluate',
  'webdriver-evaluate', 'selenium-evaluate', 'webdriverCommand',
  'webdriver-evaluate-response','__webdriverFunc', '__webdriver_script_fn',
  '__$webdriverAsyncExecutor', '__lastWatirAlert',
  '__lastWatirConfirm', '__lastWatirPrompt', '$chrome_asyncScriptInfo',
  '$cdc_asdjflasutopfhvcZLmcfl_', '_phantom', '_phantomas'];
  w.forEach((t) => {
    if (!!window[t] || !!window.document.documentElement.getAttribute(t) || !!navigator[t]) {
      r.push(t);
    }
  });
  return r;
}
// exec 使用puppteer会命中webdriver

detectWebDriver() // 如果返回内容不为空,则表示改窗口是通过自动化脚本打开的,比如 ["webdriver"]
```

## 方案

### selenium 反爬

对于selenium，实现非常简单，我们只需要增加一个参数配置，即可完美解决

```python
from selenium.webdriver.common.desired_capabilities import DesiredCapabilities
from selenium import webdriver
options = webdriver.ChromeOptions()
options.add_argument("--disable-blink-features=AutomationControlled")
driver = webdriver.Remote(
    command_executor="http://127.0.0.1:4444/wd/hub",
    desired_capabilities=DesiredCapabilities.CHROME,
    options=options
)
```

### puppeteer 反爬

对于 puppeteer ,我们可以通过在每次打开新页面时,删除掉 webdriver 属性,规避反爬虫脚本的检测


```javascript
await page.evaluateOnNewDocument(() => {
  const newProto = navigator.__proto__;
  delete newProto.webdriver;
  navigator.__proto__ = newProto;
});
await page.goto("https://your_test_url")
````